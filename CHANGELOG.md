# Changelog
All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).
  
  
## [2.1.0] - 2026-01-10

### Added
- **Stateless Architecture**: Completely removed the dependency on the local `measurement.json` file. All persistent data is now stored externally via MQTT retained messages and Home Assistant.
- **Dual-Layer State Recovery**: Implemented a robust recovery mechanism to prevent data loss. On startup, the addon first attempts to recover state from MQTT. If that fails, it performs a "Surgical Fallback" to the Home Assistant REST API.
- **Surgical HA API Recovery**: The fallback mechanism now uses advanced fuzzy pattern matching to find meter totals even if sensors have been renamed in Home Assistant. It includes strict exclusions (ignoring costs, energy prices, and unrelated sensors) and handles localized number formats (European thousand separators).
- **Dynamic Discovery**: Implemented on-the-fly MQTT discovery. The addon now detects new meters and name changes in real-time and immediately pushes discovery messages to Home Assistant. This ensures that S0PCM entities appear immediately even during a "blank slate" startup.
- **Startup Synchronization**: The serial reading process now waits for 7 seconds during the "State Recovery" phase, ensuring totals are fully loaded before counting new pulses. This prevents accidental 0-value resets.
- **Enhanced Documentation**: Added comprehensive sections on "Data Accuracy & Addon Downtime" and "State Recovery & Data Safety," including critical warnings about HA API limitations when sensors are "Unavailable."

### Changed
- **Improved Security**: Removed the legacy `/share/` directory mapping from the addon configuration for better system isolation.
- **Logging Refinement**: Removed misleading logs related to the defunct `measurement.json` and improved recovery phase transparency.

### Fixed
- **HA API Permissions**: Resolved 401 Unauthorized errors by adding the necessary `homeassistant_api` permission.
- **Recovery Reliability**: Fixed structural bugs in the fallback loop and ensured that meter totals of `0` are correctly recognized as valid states.
- **Internal Stability**: Hardened the global date initialization to prevent `KeyError` on fresh installations.

## [2.0.1] - 2026-01-10
### Fixed
- **Data Migration**: Fixed a bug where legacy totals were not correctly migrated from `/share/s0pcm/` to the new private `/data/` internal storage because the migration function was not called on startup.
- **Historical Stats Preservation**: Enhanced migration logic to include `daily-*.txt` files.
- **Migration Robustness**: Added logic to ensure legacy data is restored even if a default `measurement.json` has already been generated by a previous v2.0.0 run.

## [2.0.0] - 2026-01-09
### Breaking Changes
- **Data Accessibility**: Measurement data has moved from the public `/share/s0pcm/` mapping to the addon's private `/data/` internal storage. This means you can no longer manually edit the measurement file via Samba/SSH. Use the new MQTT topics for naming meters and setting totals.
- **Removed Local Logging**: The local `s0pcm-reader.log` file has been removed. Logs are now exclusively available via the Home Assistant Addon console (stdout/stderr).

### Added
- **Native Configuration Entities**: Added `number` and `text` entities to Home Assistant. You can now rename meters and correct totals directly in the device page in Home Assistant, without needing to perform manual MQTT actions.
- **MQTT-Based State Recovery**: The addon now recovers meter totals, today's counts, and yesterday's counts from retained MQTT messages on startup if local data is missing. It now also rebuilds the Name-to-ID mapping from MQTT discovery messages, ensuring statistics stored under the meter's name are correctly recovered.
- **Remote Meter Naming**: Added support for setting meter names via MQTT (`name/set` topic). This replaces the need for manual file editing and automatically updates sensor names in Home Assistant through instant discovery refresh.
- **Automatic Data Migration**: Seamlessly migrates data from the legacy `/share/s0pcm/` location and converts YAML storage to the new JSON format.
- **Backup Advice**: Added detailed data safety and backup recommendations to `DOCS.md`.
- **Discovery Reliability**: Improved MQTT discovery by clearing previous configurations before publishing new ones, ensuring entity names update correctly in Home Assistant.
- **Force Startup Publish**: Addon now immediately publishes the current state upon connection to ensure all topics are populated.

### Changed
- **Modernized Architecture**: Removed legacy dependencies on `bashio`, `tempio`, and `config.sh`. The internal Python application was majorly refactored (including `TaskReadSerial` and `TaskDoMQTT`) to directly handle configuration, service discovery via Supervisor API, and graceful shutdowns (SIGINT/SIGTERM).
- **Private Data Storage**: Operational data (meter totals) is now stored in the addon's private `/data/` folder, protecting it from accidental external access.
- **JSON Storage**: Switched measurement data from YAML to JSON for better performance, faster updates, and unified format consistency.
- **Simplified Logging**: Removed local file logging and rotation logic. The addon now relies on Home Assistant's built-in console logging, preventing "log rotation storms" and reducing disk wear.
- **Simplified Startup**: Overhauled and simplified the `run` script and container initialization process.
- **Removed Legacy Example**: Deleted `configuration.json.example` as configuration is now fully managed via the Home Assistant UI.

### Fixed
- Fixed a race condition between the serial reader and MQTT handler that could cause "Set Total" commands (including setting to 0) to be ignored or overwritten by incoming serial data.
- Fixed a crash (`TypeError`) when clearing a meter name (setting it to empty) via MQTT.
- Fixed a `SyntaxWarning` in the MQTT recovery logic during discovery message parsing.
- Fixed recovery logic to prioritize the highest non-zero value found on MQTT, preventing stale data from overwriting newer statistics.
- Fixed a bug where meter names were not correctly restored during the MQTT recovery phase.
- Fixed energy dashboard spikes by removing redundant discovery purging on restart.

## [1.5.6] - 2026-01-06
### Changed
- Improved documentation clarity: refined configuration section headers, standardized MQTT topic placeholders, and clarified manual configuration examples.
- Added prominent security warning regarding unencrypted MQTT defaults and clarified TLS setup instructions.

## [1.5.5] - 2026-01-04
### Changed
- Harmonized note styles in `DOCS.md` to use the `[!NOTE]` blockquote format for better readability and consistency.

## [1.5.4] - 2026-01-04
### Fixed
- Fixed configuration defaults: Optional MQTT settings (mqtt_protocol, mqtt_discovery, mqtt_discovery_prefix, mqtt_retain, mqtt_split_topic) are now hidden under "Show unused optional configuration options" for a cleaner UI, while still applying correct defaults (5.0, true, homeassistant, true, true respectively) when not explicitly set.
- Changed default log_level from "warning" to "info" to match the UI default.

### Changed
- Updated DOCS.md with comprehensive configuration documentation including all optional parameters organized by category (General, Connection Settings, Advanced MQTT Settings, Security Settings) with their correct default values clearly documented.

## [1.5.3] - 2026-01-03
### Changed
- Moved Status entity to Diagnostic category in Home Assistant for better organization alongside other diagnostic sensors.

## [1.5.2] - 2026-01-03
### Changed
- Improved error sensor clarity: The error sensor now displays "No Error" instead of an empty value when the system is operating normally.

## [1.5.1] - 2026-01-03
### Added
- Expanded MQTT information: added a new `base_topic/info` topic containing addon version, hardware firmware, startup time, uptime, and serial port.
- Added MQTT Auto-Discovery for the new info sensor, appearing as a diagnostic entity in Home Assistant.
- Enhanced error reporting: converted several non-fatal logger errors (invalid dates, parsing issues, TLS fallback) to use the MQTT error topic.

## [1.5.0] - 2026-01-03
### Added
- Implemented real-time MQTT error publishing to `base_topic/error`.
- Added MQTT Auto-Discovery for the error sensor, making it automatically appear in Home Assistant as a diagnostic entity.
- Improved MQTT loop responsiveness: the script now immediately publishes updates and handles errors upon connection, and reacts instantly to changes even with long publication intervals.

## [1.4.1] - 2026-01-03
### Changed
- Overhauled and reorganized `README.md` and `DOCS.md` for better clarity and Home Assistant UI integration.

## [1.4.0] - 2026-01-03
### Added
- Implemented robust MQTT TLS support with automatic fallback to plain connections if TLS fails.
- Disabled TLS certificate verification and hostname checking by default to improve compatibility with self-signed certificates.
- Added support for external MQTT brokers with manual host, username, and password configuration options.
- Added support for manual MQTT Client ID configuration.
- Standardized MQTT base topic default to `s0pcmreader` across all files and exposed it as a UI configuration option.
- Exposed advanced MQTT parameters including Protocol version, Discovery (prefix and toggle), Retention, and Split Topic settings.
- Added configuration options for encrypted and unencrypted MQTT ports with automatic port swapping during fallback.
- Exposed TLS, Device, and Log Level options in the Home Assistant addon configuration UI for easier management.
- Added MQTT TLS documentation and HA UI configuration instructions.

## [1.3.2] - 2026-01-03
### Added
- Implemented automatic version syncing between `config.yaml` and the Python script at runtime.

## [1.3.1] - 2026-01-03
### Changed
- Fixed security issue where MQTT password was visible in debug logs.
- Updated error message to point to the new set totals method via MQTT and Actions in Home Assistant, with a reference to the documentation.


## [1.3.0] - 2026-01-02
### Added
- Added MQTT Discovery for the status topic, exposing it as a binary sensor.

## [1.2.0] - 2026-01-02
### Added
- Added ability to set meter totals via MQTT set command.

## [1.1.0] - 2026-01-02
### Added
- Added watchdog support using S6 overlay, the addon will now automatically restart if the python script crashes.
- Updated documentation to reflect watchdog behavior.

## [1.0.0] - 2026-01-02
### Added
- Added MQTT Discovery support, this will automatically add the S0PCM Reader to Home Assistant with the relevant entities.

## [0.15.1] - 2025-12-20
### Changed
- Changed base image from 3.14-alpine3.22 to 3.14-alpine3.23

## [0.15.0] - 2025-12-03
### Removed
- Removed support for 32 bit systems as Home Assistant doesn't support them anymore see https://www.home-assistant.io/blog/2025/05/22/deprecating-core-and-supervised-installation-methods-and-32-bit-systems/ for more info.

## [0.14.0] - 2025-11-09
### Changed
- Changed the version to 0.14.0 as 0.13.0 gave me bad luck, all good now

## [0.13.7] - 2025-11-09
### Fixed
- Fixed with CRLF line endings, coverted to LF fixes #23

## [0.13.6] - 2025-11-09
### Fixed
- Fixed with CRLF line endings, coverted to LF fixes #23

## [0.13.5] - 2025-11-09
### Fixed
- Fixed issue with executables not being executable

## [0.13.4] - 2025-11-09
### Removed
- Removed deprecated codenotary field

## [0.13.3] - 2025-11-09
### Removed
- Removed deprecated codenotary field

## [0.13.2] - 2025-11-09
### Removed
- Removed deprecated codenotary field

## [0.13.1] - 2025-11-08
### Removed
- Removed deprecated codenotary field

## [0.13.0] - 2025-11-08
### Changed
- Changed base image from 3.13-alpine3.22 to 3.14-alpine3.22 for aarch64 and amd64 only
### Deprecated
- With the release of Home Assistant 2025.12 support for armhf, armv7 an i386 will be dropped and this addon will remove support for them in the future as well.
  Please update your environment to either aarch64 or amd64.
  More info https://www.home-assistant.io/blog/2025/05/22/deprecating-core-and-supervised-installation-methods-and-32-bit-systems/

## [0.12.0] - 2025-10-02
### Changed
- Bump pyyaml from 6.0.2 to 6.0.3

## [0.11.0] - 2025-06-25
### Changed
- Changed base image from 3.13-alpine3.21 to 3.13-alpine3.22

## [0.10.1] - 2025-01-04
### Changed
- Update README.md

## [0.10.0] - 2024-12-14
### Changed
- Changed base image from 3.13-alpine3.20 to 3.13-alpine3.21

## [0.9.0] - 2024-11-09
### Changed
- Changed base image from 3.12-alpine3.20 to 3.13-alpine3.20

## [0.8.9] - 2024-08-31
### Fixed
- Add 'network' to apparmor to fix the issue with Debian 12 and HA Supervised, closes #20

## [0.8.7] - 2024-08-12
### Changed
- Bump pyyaml from 6.0.1 to 6.0.2

## [0.8.6] - 2024-05-26
### Changed
- Changed base image from 3.12-alpine3.19 to 3.12-alpine3.20

## [0.8.5] - 2024-05-06
### Changed
- Bump paho-mqtt from 2.0.0 to 2.1.0
- Fixed an issue which prevented the addon to get the username and password from Home Assistant, closes #17
- Added logging to see authentication issues for MQTT

## [0.8.4] - 2024-04-07
### Changed
- Improved handling an empty 'measurement.yaml' file

## [0.8.3] - 2024-04-06
### Added
- Added a check to prevent 'NoneType' is not iterable errors

## [0.8.2] - 2024-02-17
### Changed
- Removed sys from imports as no longer used

### Added
- Added more logging information to the log for the addon and for the Python script

## [0.8.0] - 2024-02-12
### Added
- Added support for MQTTv5

## [0.7.0] - 2024-02-12
### Changed
- Bump paho-mqtt from 1.6.1 to 2.0.0
- Added 'mqtt.CallbackAPIVersion.VERSION1'to Client() to support paho-mqtt 2.0.0

## [0.6.4] - 2023-12-15
### Changed
- Changed base image from 3.12-alpine3.18 to 3.12-alpine3.19

## [0.6.3] - 2023-11-04
### Added
- Added codenotary signing

## [0.6.2] - 2023-10-26
### Changed
- Remove args from build.yaml

## [0.6.1] - 2023-10-25
### Changed
- Changed base image from 3.11-alpine3.18 to 3.12-alpine3.18
- Bump some args versions

## [0.6.0] - 2023-07-23
### Fixed
- Updated requirements.txt to fix #9

## [0.5.0] - 2023-06-11
### Changed
- Changed base image from 3.10-alpine3.17 to 3.11-alpine3.18

## [0.4.0] - 2023-04-23
### Changed
- Changed base image from 3.9-alpine3.16 to 3.10-alpine3.17
- Updated dependencies

## [0.3.13] - 2023-01-09
### Fixed
- Fixed permissions issue introduced in 0.3.12

## [0.3.12] - 2023-01-09
### Changed
- Changed example YAML code for Home Assistant to show a different use case as well (thanks @wiljums)

## [0.3.11] - 2022-11-05
### Changed
- Changed example YAML code for Home Assistant to add support for the water meter in the Energy Dashboard (requires Home Assistant 2022.11 or higher)

## [0.3.10] - 2022-06-24
### Changed
- Changed example YAML code for Home Assistant because of new MQTT scheme

## [0.3.9] - 2022-06-22
### Changed
- Changed file permissions to make scripts executable

## [0.3.8] - 2022-06-22
### Changed
- Bump version to 0.3.8

## [0.3.7] - 2022-06-22
### Changed
- Bump version to 0.3.7

## [0.3.6] - 2022-06-22
### Changed
- Updated base image from v3.14 to v3.16
- Made changes to support S6-Overlay v3

## [0.3.5] - 2021-12-29
### Added
- Added URL to Github repository

## [0.3.4] - 2021-12-24
### Changed
- Moved installation instructions back to README.md

## [0.3.3] - 2021-12-24
### Added
- Added DOCS.md for documentation

## [0.3.2] - 2021-12-24
### Added
- Added apparmor.txt file for increased security

### Removed
- Removed dailystat from s0pcm_config.conf, this means we no longer get a CSV file with the daily count

## [0.3.1] - 2021-12-23
### Fixed
- Fixed a bug that caused the add-on to fail after rebooting Home Assistant (https://github.com/darkrain-nl/home-assistant-addon-s0pcm-reader/issues/3)

## [0.3.0] - 2021-12-23
### Changed
- Changed data store folder to /share/s0pcm to make it persistant (not sure if this is the best way...)

## [0.2.0] - 2021-12-22
### Added
- make it possible to use the 5 meter version as well

## [0.1.0] - 2021-12-22
### Added
- Initial local test version

[Unreleased]:
[0.2.0]: First version on Github
[0.1.0]: Local first test
